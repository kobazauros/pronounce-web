{% extends "base.html" %}

{% block title %}Student Details{% endblock %}

{% block content %}
<style>
    #noise-meter,
    #connection-status {
        display: none !important;
    }
</style>

<div class="container mx-auto px-4 py-8">
    <div class="mb-6">
        <a href="{{ url_for('dashboards.teacher_dashboard') }}"
            class="text-indigo-600 hover:underline mb-4 inline-block">&larr; Back to Dashboard</a>
        <h1 class="text-3xl font-bold text-gray-800">{{ student.first_name }} {{ student.last_name }}</h1>
        <p class="text-gray-600">Student ID: {{ student.student_id }}</p>
    </div>

    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-200 bg-gray-50">
            <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
                <h2 class="text-lg font-semibold text-gray-700">Submission History</h2>
                <form method="GET" action="{{ url_for('dashboards.student_detail', user_id=student.id) }}">
                    <div class="flex items-center gap-2">
                        <label for="test_type"
                            class="text-xs font-medium text-gray-500 uppercase tracking-wide">Filter:</label>
                        <select name="test_type" id="test_type" onchange="this.form.submit()"
                            class="text-sm border-gray-300 rounded-md shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                            <option value="all" {% if current_filter=='all' %}selected{% endif %}>Show All</option>
                            <option value="pre" {% if current_filter=='pre' %}selected{% endif %}>Pre-Test Only</option>
                            <option value="post" {% if current_filter=='post' %}selected{% endif %}>Post-Test Only
                            </option>
                        </select>
                    </div>
                </form>
            </div>
        </div>

        {% if submissions %}
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Test Type</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Word</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Audio</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">VTLN</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Score</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Flags</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                {% for sub in submissions %}
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        {{ sub.timestamp.strftime('%Y-%m-%d %H:%M') }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        {% if sub.test_type == 'pre' %}
                        <span
                            class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-indigo-100 text-indigo-800">
                            Pre-Test
                        </span>
                        {% else %}
                        <span
                            class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">
                            Post-Test
                        </span>
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                        {{ sub.target_word.text }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        <audio controls class="h-8 w-32">
                            <source src="{{ url_for('get_submission_audio', filepath=sub.file_path) }}"
                                type="audio/mpeg">
                        </audio>
                    </td>

                    <!-- Analysis Data -->
                    {% if sub.analysis %}
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        {{ "%.2f"|format(sub.analysis.scaling_factor) }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        {% set d = sub.analysis.distance_bark %}
                        {% if d is not none %}
                        {% if d < 1.5 %} <span class="text-green-600 font-bold">{{ "%.2f"|format(d) }} Bark</span>
                            {% elif d < 3.0 %} <span class="text-yellow-600 font-bold">{{ "%.2f"|format(d) }}
                                Bark</span>
                                {% else %} <span class="text-red-600 font-bold">{{ "%.2f"|format(d) }} Bark</span>
                                {% endif %}
                                {% else %}
                                <span class="text-gray-400">N/A</span>
                                {% endif %}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-xs">
                        {% if sub.analysis.is_deep_voice_corrected %}
                        <span class="px-2 py-1 bg-blue-100 text-blue-800 rounded-full mr-1">Corrected</span>
                        {% endif %}
                        {% if sub.analysis.is_outlier %}
                        <span class="px-2 py-1 bg-red-100 text-red-800 rounded-full">Outlier</span>
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        <button onclick="openChartModal('{{ sub.id }}')"
                            class="text-indigo-600 hover:text-indigo-900 font-medium">
                            View Chart
                        </button>
                    </td>
                    {% else %}
                    <td colspan="4" class="px-6 py-4 whitespace-nowrap text-sm text-gray-400 italic">
                        Pending Analysis...
                    </td>
                    {% endif %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Pagination (Active only if > 10 entries) -->
    {% if submissions.total > 10 %}
    <div class="px-6 py-4 border-t border-gray-100 bg-white flex justify-between items-center rounded-b-xl">
        <span class="text-xs text-gray-500">
            Showing <strong>{{ submissions.items|length }}</strong> of <strong>{{ submissions.total }}</strong> results
        </span>
        <div class="flex gap-2">
            {% if submissions.has_prev %}
            <a href="{{ url_for('dashboards.student_detail', user_id=student.id, page=submissions.prev_num, test_type=current_filter) }}"
                class="px-3 py-1 border border-gray-300 rounded-md text-xs text-gray-600 hover:bg-gray-100 transition">Previous</a>
            {% else %}
            <button
                class="px-3 py-1 border border-gray-200 rounded-md text-xs text-gray-400 bg-gray-50 cursor-not-allowed"
                disabled>Previous</button>
            {% endif %}

            {% if submissions.has_next %}
            <a href="{{ url_for('dashboards.student_detail', user_id=student.id, page=submissions.next_num, test_type=current_filter) }}"
                class="px-3 py-1 border border-gray-300 rounded-md text-xs text-gray-600 hover:bg-gray-100 transition">Next</a>
            {% else %}
            <button
                class="px-3 py-1 border border-gray-200 rounded-md text-xs text-gray-400 bg-gray-50 cursor-not-allowed"
                disabled>Next</button>
            {% endif %}
        </div>
    </div>
    {% endif %}
    {% else %}
    <div class="p-8 text-center text-gray-500">
        No submissions found for filter: <strong>{{ current_filter|upper }}</strong>.
    </div>
    {% endif %}
    <!-- Closing div for bg-white container -->
</div>
</div>

<!-- Modal for Vowel Chart -->
<div id="chartModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-1/2 shadow-lg rounded-md bg-white">
        <div class="mt-3 text-center">
            <h3 class="text-lg leading-6 font-medium text-gray-900" id="modalTitle">Vowel Analysis</h3>
            <div class="mt-2 px-7 py-3">
                <p id="modalSubtitle" class="text-sm text-gray-500 mb-4"></p>
                <div class="relative h-64 md:h-80 w-full"> <!-- Responsive Height -->
                    <canvas id="vowelChart"></canvas>
                </div>
            </div>
            <div class="items-center px-4 py-3">
                <button id="closeModal"
                    class="px-4 py-2 bg-gray-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-300">
                    Close
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Chart.js via CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script
    src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>

<script>
    let myChart = null;

    // Register plugin (if using module system, relevant for CDN usage sometimes)
    // Chart.register(window['chartjs-plugin-annotation']); 

    document.getElementById('closeModal').onclick = function () {
        document.getElementById('chartModal').classList.add('hidden');
    }

    async function openChartModal(subId) {
        // Show Modal
        document.getElementById('chartModal').classList.remove('hidden');
        document.getElementById('modalSubtitle').innerText = "Loading data...";

        // Fetch Data
        try {
            const resp = await fetch(`/dashboard/api/submission/${subId}/analysis`);
            const data = await resp.json();

            if (data.error) {
                alert(data.error);
                return;
            }

            // Update Text
            const label = data.metrics.vowel_label || "?";
            const dist = data.metrics.distance_bark || "N/A";
            document.getElementById('modalTitle').innerText = `Vowel Space: /${label}/`;
            document.getElementById('modalSubtitle').innerHTML = `Euclidean Distance: <b>${dist} Bark</b>`;

            renderChart(data);

        } catch (e) {
            console.error(e);
            alert("Failed to load analysis data.");
        }
    }

    function renderChart(data) {
        const ctx = document.getElementById('vowelChart').getContext('2d');

        if (myChart) myChart.destroy();

        const studentPt = { x: data.student.f2, y: data.student.f1 };
        const refPt = { x: data.reference.f2, y: data.reference.f1 };

        myChart = new Chart(ctx, {
            type: 'scatter',
            data: {
                datasets: [
                    {
                        label: 'Student',
                        data: [studentPt],
                        backgroundColor: data.student.color,
                        pointRadius: 8
                    },
                    {
                        label: 'Native Reference',
                        data: [refPt],
                        backgroundColor: data.reference.color,
                        pointRadius: 8,
                        pointStyle: 'rectRot'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        title: { display: true, text: 'F2 (Hz) - Backness' },
                        reverse: true, // Phonetic convention
                        min: 500, max: 3000
                    },
                    y: {
                        title: { display: true, text: 'F1 (Hz) - Height' },
                        reverse: true, // Phonetic convention
                        min: 200, max: 1200
                    }
                },
                plugins: {
                    annotation: {
                        annotations: {
                            line1: {
                                type: 'line',
                                xMin: studentPt.x,
                                xMax: refPt.x,
                                yMin: studentPt.y,
                                yMax: refPt.y,
                                borderColor: 'rgba(100, 100, 100, 0.5)',
                                borderWidth: 2,
                                borderDash: [5, 5],
                                arrowHeads: {
                                    end: { display: true, fill: true }
                                }
                            }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function (context) {
                                return `F1: ${context.parsed.y.toFixed(0)}, F2: ${context.parsed.x.toFixed(0)}`;
                            }
                        }
                    }
                }
            }
        });
    }
</script>
{% endblock %}