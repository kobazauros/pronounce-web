{% extends "base.html" %}

{% block title %}{{ 'Edit' if word else 'Add' }} Word{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-5 max-w-7xl h-full">

    <!-- Header & Navigation -->
    <div class="flex items-center justify-between mb-4">
        <div>
            <h1 class="text-2xl font-bold text-gray-800 tracking-tight">{{ 'Edit Word' if word else 'Add New Word' }}
            </h1>
        </div>
        {% set next_url = request.args.get('next') %}
        <a href="{{ next_url or url_for('dashboards.admin_dashboard') }}"
            class="group flex items-center px-4 py-2 bg-white border border-gray-200 text-gray-600 rounded-lg hover:border-gray-300 hover:bg-gray-50 transition shadow-sm text-sm font-medium">
            <i class="fas fa-arrow-left mr-2 group-hover:-translate-x-1 transition-transform"></i>
            Back
        </a>
    </div>

    <!-- Instructions (Collapsible) -->
    <details class="group mb-5 bg-indigo-50 border border-indigo-100 rounded-lg open:shadow-sm" open>
        <summary
            class="flex items-center justify-between px-4 py-3 cursor-pointer hover:bg-indigo-100/50 transition list-none select-none">
            <div class="flex items-center text-indigo-900 font-semibold text-sm">
                <i class="fas fa-info-circle mr-2 text-indigo-500"></i> How to use this tool
            </div>
            <i class="fas fa-chevron-down text-indigo-400 text-xs transition-transform group-open:rotate-180"></i>
        </summary>
        <div
            class="px-4 pb-4 pt-0 text-indigo-800 space-y-1 text-xs leading-relaxed border-t border-indigo-100/50 mt-1">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-1 mt-2">
                <div>
                    <p>1. <strong>Input Word</strong>: Type a mono-syllabic word and click <strong>Auto-Fetch</strong>
                        to generate the audio and IPA transcription.
                    </p>
                    <p>2. <strong>Review</strong>: Check the waveform. If noisy, download and clean audio manually.</p>
                </div>
                <div>
                    <p>3. <strong>Manual Correction</strong>: Download &rarr; Edit &rarr; Upload corrected MP3.</p>
                    <p>4. <strong>Save</strong>: Finalize to store the normalized audio.</p>
                </div>
            </div>
        </div>
    </details>

    <!-- Main Content Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

        <!-- Left Column: Edit Form -->
        <div class="lg:col-span-2">
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                <form method="POST" id="word-form" data-is-demo="{{ 'true' if is_demo else 'false' }}"
                    action="{{ url_for('dashboards.add_word', next=next_url) if not word else url_for('dashboards.edit_word', word_id=word.id, next=next_url) }}"
                    enctype="multipart/form-data">

                    <div class="p-5 space-y-4">
                        <!-- Word Text -->
                        <div>
                            <label for="word_text"
                                class="block text-xs font-bold text-gray-700 uppercase tracking-wide mb-1">Target
                                Word</label>
                            <div class="relative rounded-md shadow-sm">
                                <input type="text" name="word_text" id="word_text" placeholder="e.g., 'hello'"
                                    value="{{ word.text if word else '' }}" required
                                    class="block w-full pr-32 border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-base py-2 px-3 {% if is_demo %}opacity-60 cursor-not-allowed bg-gray-50{% endif %}"
                                    {% if is_demo %}readonly{% endif %}>
                                <div class="absolute inset-y-0 right-0 flex items-center pr-1">
                                    <button type="button" id="generate-btn"
                                        class="inline-flex items-center px-3 py-1 border border-transparent text-xs font-semibold rounded text-indigo-700 bg-indigo-100 hover:bg-indigo-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition {% if is_demo %}opacity-50 cursor-not-allowed{% endif %}">
                                        <i class="fas fa-magic mr-1"></i> Auto-Fetch
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- IPA -->
                        <div>
                            <label for="ipa_transcription"
                                class="block text-xs font-bold text-gray-700 uppercase tracking-wide mb-1">IPA
                                Transcription</label>
                            <input type="text" name="ipa_transcription" id="ipa_transcription"
                                placeholder="e.g., /həˈloʊ/" value="{{ word.ipa if word else '' }}"
                                class="block w-full border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-sm py-2 px-3 bg-gray-50 {% if is_demo %}opacity-60 cursor-not-allowed{% endif %}"
                                {% if is_demo %}readonly{% endif %}>
                        </div>

                        <!-- File Upload -->
                        <div class="pt-2">
                            <label class="block text-xs font-bold text-gray-700 uppercase tracking-wide mb-1">Manual
                                Audio Upload</label>
                            <div class="mt-1 flex justify-center px-6 py-4 border-2 border-gray-300 border-dashed rounded-lg hover:border-indigo-400 transition-colors bg-gray-50 hover:bg-white cursor-pointer {% if is_demo %}opacity-60 cursor-not-allowed{% endif %}"
                                id="drop-zone">
                                <div class="space-y-1 text-center">
                                    <i class="fas fa-cloud-upload-alt text-gray-400 text-xl mb-1"></i>
                                    <div class="text-xs text-gray-600">
                                        <span class="font-medium text-indigo-600 hover:text-indigo-500">Click to
                                            upload</span> or drag and drop
                                        <input id="audio_file" name="audio_file" type="file" accept=".mp3,.wav"
                                            class="hidden">
                                    </div>
                                    <p class="text-[10px] text-gray-400">MP3/WAV (Max 5MB)</p>
                                </div>
                            </div>
                            <div id="file-name-display" class="mt-2 text-xs text-indigo-600 hidden flex items-center">
                                <i class="fas fa-check-circle mr-1"></i>
                                <span class="font-medium"></span>
                            </div>
                        </div>
                    </div>

                    <!-- Footer -->
                    <div class="px-5 py-3 bg-gray-50 border-t border-gray-100 flex justify-between items-center">
                        <span class="text-[10px] text-gray-400">Auto-normalizes on save.</span>
                        <button type="{% if is_demo %}button{% else %}submit{% endif %}" id="save-btn"
                            class="inline-flex items-center px-5 py-2 border border-transparent shadow-sm text-sm font-medium rounded-lg text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-all {% if is_demo %}opacity-50 cursor-not-allowed{% endif %}">
                            <i class="fas fa-save mr-2"></i>
                            {{ 'Save' if word else 'Create' }}
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Right Column: Visualizer -->
        <div class="lg:col-span-1">
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 sticky top-4">
                <div class="px-5 py-3 border-b border-gray-50 bg-gray-50/50">
                    <h2 class="text-sm font-bold text-gray-700 uppercase tracking-wide">Audio Preview</h2>
                </div>

                <div class="p-5 space-y-4">
                    <!-- Status State -->
                    <div id="audio-status"
                        class="text-center py-6 text-gray-400 {{ 'hidden' if word and word.audio_path else '' }}">
                        <i class="fas fa-wave-square text-3xl mb-2 opacity-30"></i>
                        <p class="text-xs">No audio loaded</p>
                    </div>

                    <!-- Waveform Container with Data Attribute for Init -->
                    <div id="waveform-container" class="{{ 'hidden' if not (word and word.audio_path) else '' }}"
                        data-audio-path="{{ url_for('static', filename=word.audio_path) if word and word.audio_path else '' }}">

                        <div id="waveform" class="w-full h-24 bg-gray-50 rounded-lg mb-3 border border-gray-200"></div>

                        <!-- Controls -->
                        <div class="flex items-center justify-between">
                            <button id="play-pause-btn" type="button"
                                class="w-10 h-10 rounded-full bg-indigo-600 text-white flex items-center justify-center hover:bg-indigo-700 focus:outline-none shadow-md">
                                <i class="fas fa-play pl-0.5 text-xs"></i>
                            </button>
                            <span id="time-display" class="text-xs font-mono text-gray-500">0:00 / 0:00</span>
                        </div>
                    </div>

                    <!-- Actions -->
                    <div>
                        <a id="download-btn"
                            href="{{ url_for('static', filename=word.audio_path) if word and word.audio_path else '#' }}"
                            download="{{ word.text if word else 'audio' }}.mp3"
                            class="block w-full text-center px-3 py-2 border border-gray-300 shadow-sm text-xs font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none transition {{ 'hidden' if not (word and word.audio_path) else '' }}">
                            <i class="fas fa-download mr-1.5 text-gray-400"></i> Download
                        </a>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // DOM Elements
        const wordTextInput = document.getElementById('word_text');
        const ipaInput = document.getElementById('ipa_transcription');
        const generateBtn = document.getElementById('generate-btn');
        const saveBtn = document.getElementById('save-btn');
        const dropZone = document.getElementById('drop-zone');
        const audioInput = document.getElementById('audio_file');
        const fileNameDisplay = document.getElementById('file-name-display');

        // Visualizer Elements
        const audioStatus = document.getElementById('audio-status');
        const waveformContainer = document.getElementById('waveform-container');
        const playPauseBtn = document.getElementById('play-pause-btn');
        const timeDisplay = document.getElementById('time-display');
        const downloadBtn = document.getElementById('download-btn');

        // Initialize Wavesurfer
        let wavesurfer = null;

        try {
            wavesurfer = WaveSurfer.create({
                container: '#waveform',
                waveColor: '#C7D2FE', // indigo-200
                progressColor: '#4F46E5', // indigo-600
                cursorColor: '#4338ca',
                barWidth: 3,
                barRadius: 3,
                cursorWidth: 1,
                height: 96, // Matches h-24 (96px)
                barGap: 3,
                normalize: true,
            });

            // Event Listeners for Wavesurfer
            wavesurfer.on('ready', () => {
                updateTimeDisplay();
                // Ensure play button is reset to play icon
                const icon = playPauseBtn.querySelector('i');
                if (icon) icon.className = 'fas fa-play pl-0.5 text-xs';
            });

            wavesurfer.on('audioprocess', updateTimeDisplay);
            wavesurfer.on('interaction', updateTimeDisplay);

            wavesurfer.on('finish', () => {
                const icon = playPauseBtn.querySelector('i');
                if (icon) icon.className = 'fas fa-play pl-0.5 text-xs';
            });

        } catch (e) {
            console.error("Wavesurfer failed to init:", e);
        }

        function updateTimeDisplay() {
            if (!wavesurfer) return;
            const current = formatTime(wavesurfer.getCurrentTime());
            const total = formatTime(wavesurfer.getDuration());
            timeDisplay.textContent = `${current} / ${total}`;
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
        }

        /* --- Play/Pause Toggle --- */
        playPauseBtn.addEventListener('click', () => {
            if (!wavesurfer) return;
            wavesurfer.playPause();
            const isPlaying = wavesurfer.isPlaying();
            const icon = playPauseBtn.querySelector('i');
            if (icon) icon.className = isPlaying ? 'fas fa-pause' : 'fas fa-play pl-0.5 text-xs';
        });

        /* --- Helper to Load Audio into Visualizer --- */
        function loadAudioPreview(url) {
            if (!wavesurfer) return;

            // Show UI
            audioStatus.classList.add('hidden');
            waveformContainer.classList.remove('hidden');

            // Show download button logic
            downloadBtn.classList.remove('hidden');

            // If it's a blob/local file, we can't easily set the download href to a server path yet.
            if (!url.startsWith('blob:')) {
                downloadBtn.href = url;
                downloadBtn.download = (wordTextInput.value || 'audio') + '.mp3';
            }

            wavesurfer.load(url);
        }

        /* --- 1. Handle "Auto-Fetch" --- */
        generateBtn.addEventListener('click', async () => {
            const word = wordTextInput.value.trim();
            if (!word) {
                alert('Please enter a word first.');
                return;
            }

            const originalText = generateBtn.innerHTML;
            generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            generateBtn.disabled = true;

            try {
                const response = await fetch(`/dashboard/admin/generate-pronunciation?word=${encodeURIComponent(word)}`);
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to fetch data.');
                }
                const data = await response.json();

                if (data.ipa) ipaInput.value = data.ipa;
                if (data.audio_path) {
                    loadAudioPreview(data.audio_path);
                } else {
                    alert('Meta data found, but no audio available for this word.');
                }

            } catch (error) {
                console.error(error);
                alert(`Error: ${error.message}`);
            } finally {
                generateBtn.innerHTML = originalText;
                generateBtn.disabled = false;
            }
        });

        /* --- 2. Handle Manual Upload Preview --- */
        audioInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                // Update File Name Display
                fileNameDisplay.classList.remove('hidden');
                fileNameDisplay.querySelector('span').textContent = file.name;

                // Create Object URL for preview
                const objectUrl = URL.createObjectURL(file);
                loadAudioPreview(objectUrl);

                // Hide download button for manual uploads as per standard UX
                downloadBtn.classList.add('hidden');
            }
        });

        /* --- Init for existing word via Data Attribute --- */
        const initialAudioPath = waveformContainer.dataset.audioPath;
        if (initialAudioPath) {
            loadAudioPreview(initialAudioPath);
        }

        /* --- Demo Mode Logic --- */
        const isDemo = document.getElementById('word-form').dataset.isDemo === 'true';
        if (isDemo) {
            // General function to show alert and block action
            const blockAction = (e) => {
                e.preventDefault();
                e.stopPropagation();
                alert('This feature is disabled in DEMO mode');
                return false;
            };

            // Block Drop Zone
            dropZone.addEventListener('click', blockAction);

            // Block Generate Button
            generateBtn.addEventListener('click', blockAction);

            // Block Save Button
            saveBtn.addEventListener('click', blockAction);

            // Block Inputs
            [wordTextInput, ipaInput].forEach(input => {
                input.addEventListener('mousedown', (e) => {
                    e.preventDefault(); // Don't allow focus
                    alert('This feature is disabled in DEMO mode');
                });
            });

        } else {
            // Normal Event Listeners if NOT demo mode
            dropZone.addEventListener('click', () => {
                audioInput.click();
            });
        }

    });
</script>
{% endblock %}